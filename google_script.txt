/* Send Confirmation Email with Google Forms */
 
function Initialize() {
 
  var triggers = ScriptApp.getProjectTriggers();
 
  for (var i in triggers) {
    ScriptApp.deleteTrigger(triggers[i]);
  }
 
  ScriptApp.newTrigger("SendConfirmationMail")
    .forSpreadsheet(SpreadsheetApp.getActiveSpreadsheet())
    .onFormSubmit()
    .create();
 
}
 
function SendConfirmationMail(e) {
 
  try {
 
    var ss, cc, sendername, subject, columns;
    var message, value, textbody, receiver;
    var total;
 
    // This is your email address and you will be in the CC
    cc = "gelarbudayamarketing@gmail.com";
 
    // This will show up as the sender's name
    sendername = "GAYA Ticketing";
 
    // Optional but change the following variable
    // to have a custom subject for Google Docs emails
    subject = "GAYA Online Purchase Order Confirmation";
 
    // This is the body of the auto-reply
    message = "Thank you for ordering through our online system. This is a confirmation and summary of your ticket order.<br><br>";
    
    total = 0;
    if (e.namedValues["Matinee Show (Balcony)"].toString() !== ""){
      message += "Matinee Show Balcony x" + e.namedValues["Matinee Show (Balcony)"] + "<br>";
      total += 19*e.namedValues["Matinee Show (Balcony)"];
    }
    if (e.namedValues["Matinee Show (Standard)"].toString() !== ""){
      message += "Matinee Show Standard x" + e.namedValues["Matinee Show (Standard)"] + "<br>";
      total += 24*e.namedValues["Matinee Show (Standard)"];
    }
    if (e.namedValues["Matinee Show (Premiere)"].toString() !== ""){
      message += "Matinee Show Premiere x" + e.namedValues["Matinee Show (Premiere)"] + "<br>";
      total += 28*e.namedValues["Matinee Show (Premiere)"];
    }
    if (e.namedValues["Night Show (Balcony)"].toString() !== ""){
      message += "Night Show Balcony x" + e.namedValues["Night Show (Balcony)"] + "<br>";
      total += 19*e.namedValues["Night Show (Balcony)"];
    }
    if (e.namedValues["Night Show (Standard)"].toString() !== ""){
      message += "Night Show Standard x" + e.namedValues["Night Show (Standard)"] + "<br>";
      total += 24*e.namedValues["Night Show (Standard)"];
    }
    if (e.namedValues["Night Show (Premiere)"].toString() !== ""){
      message += "Night Show Premiere x" + e.namedValues["Night Show (Premiere)"] + "<br>";
      total += 28*e.namedValues["Night Show (Premiere)"];
    }
    message += "________________________________+<br>";    
    message += "Total $" + total + "<br><br>";
    message += "Transaction Number:" + e.namedValues["Transaction Number"] + "<br><br>";
    
    message += "You will be contacted once the transfer has been validated. If you have any other enquiries, feel free to contact us at janastasia.2014@economics.smu.edu.sg.<br><br>";
    message += "Thank you.<br><br>";
    message += "Signed,<br>";
    message += "GAYA Ticketing Team";
 
    // This is the submitter's email address
    // Make sure you have a field called Email Address in the Google Form
    receiver = e.namedValues["Email"].toString();
 
//    ss = SpreadsheetApp.getActiveSheet();
//    columns = ss.getRange(1, 1, 1, ss.getLastColumn()).getValues()[0];
    
    // Only include form values that are not blank
//    for (var keys in columns) {
//      var key = columns[keys];
//      var val = e.namedValues[key] ? e.namedValues[key].toString() : "";
//      if (val !== "") {
//        message += key + ' : ' + val + "<br />";
//      }
//    }
 
    textbody = message.replace("<br>", "\n");
    
    if (total > 0){
      GmailApp.sendEmail(receiver, subject, textbody, {
        cc: cc,
        name: sendername,
        htmlBody: message
      });
    }
 
  } catch (e) {
    Logger.log(e.toString());
    GmailApp.sendEmail("gelarbudayamarketing@gmail.com", "ERROR_IN_TICKETING", e.toString(), {
        name: "Luccan",
        htmlBody: e.toString()
      });
  }
 
}